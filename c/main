/*******************************************************************
 * File:        main
 * Purpose:     WimpTextRender command line tool
 * Author:      Gerph
 ******************************************************************/

#include <assert.h>
#include <stdlib.h>
#include <stdio.h>

#include "swis.h"

#include "GContext/gcontext.h"
#include "textrender.h"
#include "vdu5chars.h"

#include "VersionNum"

int main(int argc, char *argv[])
{
    textrender_t *trender;
    gcontext_t *gcontext = gcontext_initvdu(2);

    vdu5chars_define();

#ifdef TEST_GCONTEXT
    gcontext->rectangle_fill(gcontext, 0x81397900, 64, 64, 500,500);
#endif

    trender = textrender_init(gcontext);
    textrender_setfont(trender);

    {
        const char *msg = "Hello world! \x80 \x81 \x82 \x83 \x84 \x85 \x88 \x89 \x8a \x8b \x98";
        /*
    Symbol_Tick             = 0x80
    Symbol_NotMaximised     = 0x81
    Symbol_Maximised        = 0x82
    Symbol_Resize           = 0x83
    Symbol_Close            = 0x84
    Symbol_Back             = 0x85
    Symbol_Left             = 0x88
    Symbol_Right            = 0x89
    Symbol_Down             = 0x8A
    Symbol_Up               = 0x8B
    Symbol_Iconise          = 0x98
        */
        int width = textrender_stringwidth(trender, msg, 0);
        textrender_setcolours(trender, 0x00000000, 0x8888FF00);
        textrender_paint(trender, msg, TEXTRENDER_TERM0, 64, 800);
        gcontext->line_start(gcontext, 0xFF000000);
        gcontext->line_line(gcontext, 64, 800, 64+width, 800);
        gcontext->line_end(gcontext);
    }

    {
        const char *msg = "You keep using that word; I don't think it means what you think it means.";
        int x = 48;
        int y = 760;
        int width = 136;
        for (y = 760; y > 100; y -= 40)
        {
            const char *end = textrender_stringwidthwithsplit(trender, msg, TEXTRENDER_TERM0, width, ' ');
            int len = end - msg;
            textrender_paint(trender, msg, len, x, y);
            gcontext->line_start(gcontext, 0xFF000000);
            gcontext->line_line(gcontext, x, y, x+width, y);
            gcontext->line_end(gcontext);
            width += 20;
        }
    }

#if 0 /* Disable so that the CI passes */
    getchar(); /* Wait for key press */
#endif
    _swix(OS_WriteI + 12, 0); /* Clear screen */

    {
        const char *msg = "You keep using that word; I don't think it means what you think it means.";
        int x = 48;
        int y = 760;
        int width = 136;
        for (y = 760; y > 100; y -= 40)
        {
            char buffer[256];
            int buffersize = sizeof(buffer);
            int len = textrender_truncatewithellipsis(trender,
                                                      msg, TEXTRENDER_TERM0,
                                                      buffer, buffersize,
                                                      width);
            assert(len > 0);
            textrender_paint(trender, buffer, len, x, y);
            gcontext->line_start(gcontext, 0xFF000000);
            gcontext->line_line(gcontext, x, y, x+width, y);
            gcontext->line_end(gcontext);
            width += 20;
        }
    }




    exit(EXIT_SUCCESS);
}
