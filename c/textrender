/*******************************************************************
 * File:        textrender
 * Purpose:     Rendering interface for the WindowManager
 * Author:      Gerph
 * Date:        11 Jan 2026
 ******************************************************************/

#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>

#include "GContext/gcontext.h"
#include "textrender.h"
#include "wimpsymbol.h"

#define WIMP_FONTNAME_VAR "Wimp$Font"
#define WIMP_FONTSIZE_VAR "Wimp$FontSize"
#define WIMP_FONTWIDTH_VAR "Wimp$FontWidth"

#define WIMP_FONTXSIZE (12 * 16)
#define WIMP_FONTYSIZE (12 * 16)

#define DEFAULT_FG  (0xFFFFFF00u)
#define DEFAULT_BG  (0x00000000u)

struct textrender_s {
    gcontext_t *gcontext;
    font_t font;
    font_t wimpsymbol;
    colour_t fg, bg;
};


#define DEBUG

#ifdef DEBUG
#define dprintf if (1) printf
#else
#define dprintf if (0) printf
#endif


/*************************************************** Gerph *********
 Function:      textrender_init
 Description:   Initialise the text rendering system
 Parameters:    gcontext-> the context we're using this render in
 Returns:       text rendering object, or NULL if failed
 ******************************************************************/
textrender_t *textrender_init(gcontext_t *gcontext)
{
    textrender_t *trender = calloc(sizeof(*trender), 1);
    if (trender == NULL)
        return trender;
    trender->gcontext = gcontext;
    trender->font = FONT_NONE;
    trender->fg = DEFAULT_FG;
    trender->bg = DEFAULT_BG;
    trender->wimpsymbol = FONT_NONE;
    return trender;
}

/*************************************************** Gerph *********
 Function:      textrender_getdefaultfontname
 Description:   Read the default font to use when no explicit font configured
 Parameters:    trender-> the context
 Returns:       font name, or NULL if using system font
 ******************************************************************/
const char *textrender_getdefaultfontname(textrender_t *trender)
{
    /* FIXME: Read the NVRAM configuration */
    return NULL;
}

/*************************************************** Gerph *********
 Function:      textrender_readfont
 Description:   Read the font that should be used for this context
 Parameters:    trender-> the rendering context
                desktopfont-> where to populate the font to use
 Returns:       none
 ******************************************************************/
void textrender_readfont(textrender_t *trender, desktopfont_t *desktopfont)
{
    const char *fontname = getenv(WIMP_FONTNAME_VAR);
    const char *size;
    int32_t xsize = WIMP_FONTXSIZE;
    int32_t ysize = WIMP_FONTYSIZE;

    desktopfont->fontname[0] = '\0';
    desktopfont->systemfont = true;

    /* Determine font name */
    if (fontname != NULL)
    {
        strncpy(desktopfont->fontname, fontname, sizeof(desktopfont->fontname));
        desktopfont->systemfont = false;
    }
    else
    {
        /* Read font from NVRAM */
        fontname = textrender_getdefaultfontname(trender);
        if (fontname != NULL)
        {
            strncpy(desktopfont->fontname, fontname, sizeof(desktopfont->fontname));
            desktopfont->systemfont = false;
        }
    }

    /* Determine font size */
    size = getenv(WIMP_FONTSIZE_VAR);
    if (size != NULL)
    {
        int value = atoi(size); /* Should this be an OS_ReadUnsigned? */
        if (value > 0 && value < 256*16)
        {
            xsize = value;
            ysize = value;
        }
    }
    size = getenv(WIMP_FONTWIDTH_VAR);
    if (size != NULL)
    {
        int value = atoi(size); /* Should this be an OS_ReadUnsigned? */
        if (value > 0 && value < 256*16)
        {
            xsize = value;
        }
    }

    desktopfont->xsize = xsize;
    desktopfont->ysize = ysize;
    dprintf("textrender_readfont(): %s, at %i x %i\n", desktopfont->systemfont ? "SYSTEM" : desktopfont->fontname,
                                                       desktopfont->xsize, desktopfont->ysize);
}


/*************************************************** Gerph *********
 Function:      textrender_setfont
 Description:   Set the font for the text rendering operations
 Parameters:    trender-> the rendering context
 Returns:       none
 ******************************************************************/
void textrender_setfont(textrender_t *trender)
{
    desktopfont_t dtf;
    textrender_readfont(trender, &dtf);
    if (trender->font != FONT_NONE)
    {
        trender->gcontext->text_losefont(trender->gcontext, trender->font);
        trender->font = FONT_NONE;
    }
    if (! dtf.systemfont)
    {
        font_t font;
        font = trender->gcontext->text_findfont(trender->gcontext, dtf.fontname, dtf.xsize, dtf.ysize);
        trender->font = font;
    }

    /* Setup the wimp symbol font */
    trender->wimpsymbol = trender->gcontext->text_findfont(trender->gcontext, "WimpSymbol", dtf.xsize, dtf.ysize);
}


/*************************************************** Gerph *********
 Function:      textrender_setcolours
 Description:   Set the colours for the text rendering
 Parameters:    trender-> the rendering context
                bg, fg = the colours to use
 Returns:       none
 ******************************************************************/
void textrender_setcolours(textrender_t *trender, colour_t bg, colour_t fg)
{
    trender->bg = bg;
    trender->fg = fg;
}


/*************************************************** Gerph *********
 Function:      textrender_paint
 Description:   Draw some simple text
 Parameters:    trender-> the rendering context
                text-> string to render
                x = position
                y = position
 Returns:       none
 ******************************************************************/
void textrender_paint(textrender_t *trender, const char *text, int x, int y)
{
    const char *newtext = wimpsymbol_convert(text,
                                             trender->gcontext->text_readhandle(trender->gcontext, trender->wimpsymbol),
                                             trender->gcontext->text_readhandle(trender->gcontext, trender->font));
    trender->gcontext->text_paint(trender->gcontext, trender->font,
                                  x, y, trender->bg, trender->fg,
                                  newtext, -1);
    wimpsymbol_free(newtext);
}


/*************************************************** Gerph *********
 Function:      textrender_stringwidth
 Description:   Read the width of a string on screen (Wimp_TextOp 1-like)
 Parameters:    trender-> the rendering context
                text-> string to size, ctrl terminated)
                len = the length of the string (or <=0 for whole string)
 Returns:       the width in OS units
 ******************************************************************/
int32_t textrender_stringwidth(textrender_t *trender, const char *text, int len)
{
    int32_t width;
    stringbounds_t bounds;
    if (len == 0)
        len = -1;
    {
        /* FIXME Length not handled in symbol conversion */
        const char *newtext = wimpsymbol_convert(text,
                                                 trender->gcontext->text_readhandle(trender->gcontext, trender->wimpsymbol),
                                                 trender->gcontext->text_readhandle(trender->gcontext, trender->font));
        /* FIXME: text should be control terminated, but getstringsize treats it as 0-terminated */
        trender->gcontext->text_getstringsize(trender->gcontext, trender->font,
                                              &bounds, 0x7FFFFFFF,
                                              newtext, len, -1);
        if (bounds.rbearing > bounds.xoffset)
            width = bounds.rbearing;
        else
            width = bounds.xoffset;
        wimpsymbol_free(newtext);
    }

    return width;
}
